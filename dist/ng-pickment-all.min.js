// pickment v0.9.0, Mikael Tilly, MIT License
angular.module("pickment",[]).value("pickmentConfig",{options:{defaults:{preview:!0,alpha:!0,mode:"hue",format:"hex",size:256,position:["left","top","left","top"]}},elements:{picker:'<div id="pickmentPicker" tabindex="0"></div>',overlay:"<div></div>"},styles:{picker:{"background-color":"transparent",outline:"none",position:"absolute",top:"0px",left:"0px","z-index":100001,display:"none","pointer-events":"none","-moz-user-select":"-moz-none","-khtml-user-select":"none","-webkit-user-select":"none","-o-user-select":"none","user-select":"none"},overlay:{"background-color":"transparent",height:"100%",width:"100%",position:"fixed",top:"0px",left:"0px","z-index":1e5,display:"none"}},resources:{alphaPatternImage:{type:"image",width:16,height:16,url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABlBMVEX///+AgIBizNOVAAAAE0lEQVR4AWOAAUYoGCCBAbcfCgBFEACB1bzUwAAAAABJRU5ErkJggg=="}}}).value("pickmentModes",{}).directive("pickment",["pickmentService",function(a){return{restrict:"E",scope:{color:"=ngModel"},replace:!0,template:'<div class="pickment" style="background-color: {{color}};" tabindex="0"></div>',link:function(b,c,d){c.on("click",function(){a.open(c,b,b.color,d)}).on("keyup",function(e){13==e.keyCode&&a.open(c,b,b.color,d)}),b.$on("pickment.pickcolor",function(a,c){b.$apply(function(){b.color=c})})}}}]).service("pickmentService",["$document","$q","pickmentConfig","pickmentModes",function(a,b,c,d){function e(a,b){var d={};for(var e in b)b.hasOwnProperty(e)&&(d[e]=a[e]?a[e]:b[e]);return d.format=d.format||k.getFormat(),d.size=Math.max(32,parseInt(d.size,10)),d.preview="string"==typeof d.preview?"true"==d.preview:d.preview,d.alpha="string"==typeof d.alpha?"true"==d.alpha:d.alpha,d.position=d.position.toLowerCase().trim().replace(","," ").replace(/\s+/g," ").split(" ").concat([null,null,null,null]).slice(0,4).map(function(a,b){return a?a:c.options.defaults.position[b]}).map(function(a){switch(a){case"left":case"top":return 0;case"center":case"middle":return.5;case"right":case"bottom":return 1;default:return isFinite(parseFloat(a))?parseFloat(a)/100:0}}),d}function f(){var a={width:0,height:0,left:0,top:0},b=m[0].getBoundingClientRect();return angular.forEach(d[r.mode].elements,function(b){if(b.display(r)){var c=b.getSize(r.size);a.width+=c.width,a.height=Math.max(a.height,c.height)}}),a.left=b.left+window.scrollX,a.top=b.top+window.scrollY,a.left+=b.width*r.position[2],a.top+=b.height*r.position[3],a.left-=a.width*r.position[0],a.top-=a.height*r.position[1],a.left+a.width>window.innerWidth&&(a.left=window.innerWidth-a.width),a.left<0&&(a.left=0),a.top+a.height>window.innerHeight&&(a.top=window.innerHeight-a.height),a.top<0&&(a.top=0),o.css({height:a.height+"px",width:a.width+"px",left:a.left+"px",top:a.top+"px",display:"block"}),q.css({display:"block"}),o[0].getBoundingClientRect()}function g(b){var c=null,d=[];for(var e in b.elements)b.elements.hasOwnProperty(e)&&b.elements[e].display(r)&&(t[e]=b.elements[e].createElement(t[e]=b.elements[e].getSize(r.size)),t[e][0].dataset.elementType=e,t[e].css("pointer-events","auto"),o.append(t[e]),d[e]=t[e][0].getBoundingClientRect(),u[e]=b.elements[e].createMarker(),u[e]&&(o.append(u[e]),b.elements[e].updateMarker(b.elements[e].getPosition(k),u[e],d[e],p)),t[e].on("mousemove mouseup",function(a){var e=a.target.dataset.elementType;c==e&&i(b,a,e,d[e],!1)}).on("mousedown",function(a){c=a.target.dataset.elementType,angular.forEach(t,function(a,b){b!=c&&a.css("pointer-events","none")})}).on("mouseup",function(a){h(b,t,a.target.dataset.elementType),c=null}),b.elements[e].render(t[e][0],tinycolor(k.toString())));q.on("mousemove mouseup",function(a){c&&i(b,a,c,d[c],!0)}).on("mouseup",function(){h(b,t,c),c=null}),a.on("mouseout",function(a){"HTML"==a.target.nodeName&&(h(b,t,c),c=null)})}function h(a,b,c){c&&a.elements[c].onPick&&a.elements[c].onPick(s),angular.forEach(b,function(a){a.css("pointer-events","auto")})}function i(a,b,c,d,e){var f,g,h;e?(f=Math.min(Math.max(b.clientX,d.left),d.left+d.width)-d.left,g=Math.min(Math.max(b.clientY,d.top),d.top+d.height)-d.top):(f=b.clientX-d.left,g=b.clientY-d.top),u[c]&&a.elements[c].updateMarker({x:f/d.width,y:g/d.height},u[c],d,p),k=a.elements[c].getColor(f/d.width,g/d.height,tinycolor(k.toString())),j(k),a.elements[c].onSelect&&(h=a.elements[c].onSelect(),h&&h.forEach(function(b){a.elements[b].display(r)&&a.elements[b].render(t[b][0],tinycolor(k.toString()))}))}function j(a){var b,c="to"+r.format.substr(0,1).toUpperCase()+r.format.substr(1).toLowerCase()+"String";return c in a&&(b=a[c](),n.$emit("pickment.pickcolor",b)),b}var k,l,m,n,o,p,q,r,s=this,t={},u={};o=angular.element(c.elements.picker).css(c.styles.picker).on("keydown",function(a){switch(a.keyCode){case 27:j(l),s.close();break;case 13:j(k),s.close()}}),q=angular.element(c.elements.overlay).css(c.styles.overlay).on("click",function(){s.close()}),angular.element(document.body).append(o).append(q),s.getResource=function(a){var d,e,f,g=[];if(!a)return b().reject("No resource id provided");angular.isString(a)&&(a=[a]);for(var h=0,i=a.length;i>h;h++){if(d=a[h],d in c.resources)e=c.resources[d];else switch(c.resources[d]=e={url:d,type:null,obj:null},e.url.toLowerCase().substr(e.url.lastIndexOf("."))){case".png":case".jpg":case".gif":case".webp":case".svg":e.type="image";break;default:e.type="html"}if("obj"in e&&e.obj)f=function(a){return b.when(a)}(e.obj);else switch(e.type){case"image":f=function(a){return b(function(b,c){a.obj=new Image(a.width,a.height),a.obj.onerror=c,a.obj.onload=function(){b(a.obj)},a.obj.src=a.url})}(e);break;default:f=function(a){return $http.get(a.url).then(function(b){return a.obj=b,b})}(e)}g.push(f)}return 1==g.length?g[0]:b.all(g)},s.registerMode=function(a,b){d[a]=b},s.open=function(a,b,h,i){m=a,n=b,k=tinycolor(h),k.isValid()||(k=tinycolor({r:255,g:0,b:0,a:1})),l=tinycolor(k.toString()),r=e(i,c.options.defaults),p=f(),r.mode in d?g(d[r.mode]):(console.error("No '"+r.mode+"' mode defined for Pickment."),s.close()),o[0].focus(),b.$emit("pickment.open",{close:s.close})},s.close=function(){o.css({display:"none"}),q.css({display:"none"}).off("mousedown mouseup mousemove"),angular.forEach(t,function(a){a.remove()}),angular.forEach(u,function(a){a&&a.remove()}),t={},u={},m=null,n.$emit("pickment.close"),n=null}}]);